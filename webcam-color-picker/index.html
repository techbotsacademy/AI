<!--
Color Picker Webcam Demo
Single-file HTML + JS demo that accesses the webcam, samples color under the cursor (or center),
and shows RGB + HEX values plus a preview swatch. Works locally — open in a modern browser (HTTPS or localhost).

Usage:
 - Allow camera access when prompted.
 - Move the mouse over the preview area to see live color under the crosshair.
 - Click to lock the color. Click "Unlock" to continue live sampling.
 - Use the slider to change sampling area (1-15 px).
 - Copy RGB or HEX to clipboard using the buttons.

Note: Browsers require HTTPS for getUserMedia except on localhost.
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Webcam Color Picker — RGB & HEX</title>
  <style>
    :root{
      --bg:#0f172a; --card:#0b1220; --muted:#94a3b8; --accent:#06b6d4;
      --success:#16a34a; --danger:#ef4444; --glass: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;color:#e6eef6;background:linear-gradient(180deg,#071029 0%, #041024 100%);}
    .wrap{max-width:980px;margin:28px auto;padding:20px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 6px 24px rgba(2,6,23,0.6);}
    h1{margin:0 0 12px;font-size:20px}
    p.lead{margin:0 0 18px;color:var(--muted);font-size:14px}

    .main{display:grid;grid-template-columns:1fr 320px;gap:18px;align-items:start}
    .stage{position:relative;border-radius:10px;overflow:hidden;background:#000;min-height:360px;border:1px solid rgba(255,255,255,0.03)}
    video{display:block;max-width:100%;width:100%;height:auto}
    canvas#overlay{position:absolute;inset:0;pointer-events:none}

    .controls{padding:14px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006));border:1px solid rgba(255,255,255,0.02)}
    .row{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    label{font-size:13px;color:var(--muted)}
    input[type=range]{width:100%}
    .swatch{width:72px;height:72px;border-radius:8px;border:1px solid rgba(0,0,0,0.25);box-shadow:inset 0 1px 0 rgba(255,255,255,0.03)}
    .vals{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace;background:var(--glass);padding:10px;border-radius:8px;font-size:13px;color:#dff3fb}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#dff3fb;padding:8px 10px;border-radius:8px;cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#0ea5b5);border:none;color:#012;}
    .meta{font-size:12px;color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .footer{margin-top:12px;font-size:12px;color:var(--muted)}

    @media(max-width:880px){.main{grid-template-columns:1fr;}.controls{order:2;margin-top:12px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Webcam Color Picker — shows RGB & HEX</h1>
        <p class="lead">Move the mouse over the live preview or click to lock the color. Works on modern browsers (HTTPS or localhost).</p>
      </div>
      <div class="meta">Built for demo • Granted camera access only while this page is open</div>
    </div>

    <div class="main">
      <div>
        <div class="stage" id="stage">
          <!-- Hidden video used to capture stream -->
          <video id="video" playsinline autoplay muted></video>
          <!-- Offscreen canvas does pixel sampling (not visible) -->
          <canvas id="overlay"></canvas>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
          <button id="startBtn" class="primary">Start Camera</button>
          <button id="stopBtn">Stop Camera</button>
          <div class="small" id="status">Status: <span style="color:var(--muted)">idle</span></div>
        </div>
      </div>

      <div class="controls">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <div style="display:flex;gap:10px;align-items:center;">
            <div class="swatch" id="swatch" title="Current color"></div>
            <div>
              <div class="vals" id="rgbVal">R: - &nbsp; G: - &nbsp; B: -</div>
              <div class="vals" id="hexVal">HEX: -</div>
            </div>
          </div>
        </div>

        <div class="row">
          <label style="flex:1">Sampling area (px): <span id="sampleSizeLbl">5</span></label>
          <input id="sampleSize" type="range" min="1" max="15" value="5">
        </div>

        <div class="row">
          <label style="flex:1">Sampling mode</label>
          <select id="mode">
            <option value="follow">Follow cursor</option>
            <option value="center">Center crosshair</option>
          </select>
        </div>

        <div class="row">
          <button id="copyRgb">Copy RGB</button>
          <button id="copyHex">Copy HEX</button>
          <button id="lockBtn">Lock</button>
          <div style="flex:1;text-align:right" class="small">FPS: <span id="fps">0</span></div>
        </div>

        <div class="footer">Tip: Use HTTPS or open the file on <code>localhost</code>. If camera doesn't start, check browser permissions and that another tab isn't using the camera.</div>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const swatch = document.getElementById('swatch');
    const rgbVal = document.getElementById('rgbVal');
    const hexVal = document.getElementById('hexVal');
    const sampleSize = document.getElementById('sampleSize');
    const sampleSizeLbl = document.getElementById('sampleSizeLbl');
    const mode = document.getElementById('mode');
    const copyRgb = document.getElementById('copyRgb');
    const copyHex = document.getElementById('copyHex');
    const lockBtn = document.getElementById('lockBtn');
    const fpsEl = document.getElementById('fps');

    let stream = null;
    let ctx = null; // overlay 2d context for crosshair
    let offscreen = null; // offscreen canvas to sample pixels
    let offCtx = null;
    let width = 640, height = 480;
    let mouseX = 0, mouseY = 0;
    let lockedColor = null;
    let sampling = true;
    let lastFrameTime = performance.now();
    let frames = 0;

    function setStatus(text, color){ statusEl.innerHTML = 'Status: <span style="color:'+ (color||'var(--muted)') +'">'+text+'</span>'; }

    async function startCamera(){
      if(stream) return;
      try{
        setStatus('starting camera...');
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: {ideal:1280}, height: {ideal:720} }, audio:false });
        video.srcObject = stream;
        await video.play();
        // set canvas sizes
        width = video.videoWidth || 640;
        height = video.videoHeight || 480;
        overlay.width = width; overlay.height = height;
        overlay.style.width = '100%';
        offscreen = document.createElement('canvas'); offscreen.width = width; offscreen.height = height;
        ctx = overlay.getContext('2d'); offCtx = offscreen.getContext('2d');
        setStatus('camera running','var(--success)');
        sampling = true; lockedColor = null; lockBtn.textContent = 'Lock';
        requestAnimationFrame(loop);
      }catch(err){
        console.error(err);
        setStatus('camera error: ' + (err.message||err),'var(--danger)');
        stream = null;
      }
    }

    function stopCamera(){
      if(!stream) return;
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
      video.pause(); video.srcObject = null;
      setStatus('stopped');
      ctx && ctx.clearRect(0,0,overlay.width,overlay.height);
    }

    function loop(now){
      if(!stream) return;
      frames++;
      const dt = now - lastFrameTime;
      if(dt >= 500){ // update FPS twice a second
        fpsEl.textContent = Math.round((frames*1000)/dt);
        frames = 0; lastFrameTime = now;
      }

      // draw current video frame to offscreen then sample
      try{
        offCtx.drawImage(video,0,0,offscreen.width, offscreen.height);
      }catch(e){ /* drawing failed if video not ready */ }

      // sampling coordinate
      let sx, sy;
      if(mode.value === 'center'){
        sx = Math.floor(offscreen.width/2);
        sy = Math.floor(offscreen.height/2);
      }else{
        // convert mouse coords in client space to video pixel coords
        const rect = overlay.getBoundingClientRect();
        const scaleX = offscreen.width / rect.width;
        const scaleY = offscreen.height / rect.height;
        sx = Math.floor((mouseX - rect.left) * scaleX);
        sy = Math.floor((mouseY - rect.top) * scaleY);
      }

      // ensure coords in bounds
      sx = Math.max(0, Math.min(offscreen.width-1, sx));
      sy = Math.max(0, Math.min(offscreen.height-1, sy));

      if(sampling && offCtx){
        const size = Math.max(1, parseInt(sampleSize.value,10));
        const half = Math.floor(size/2);
        const sx0 = Math.max(0, sx-half);
        const sy0 = Math.max(0, sy-half);
        const w = Math.min(size, offscreen.width - sx0);
        const h = Math.min(size, offscreen.height - sy0);
        let img;
        try{ img = offCtx.getImageData(sx0, sy0, w, h).data; }catch(e){ img=null; }
        if(img && img.length>=4){
          // average pixels
          let r=0,g=0,b=0,c=0;
          for(let i=0;i<img.length;i+=4){ r+=img[i]; g+=img[i+1]; b+=img[i+2]; c++; }
          r=Math.round(r/c); g=Math.round(g/c); b=Math.round(b/c);
          if(!lockedColor){ updateColor(r,g,b); }
        }
      }

      // draw overlay: transparent darkened layer + crosshair
      drawOverlay(sx,sy);

      requestAnimationFrame(loop);
    }

    function drawOverlay(px,py){
      if(!ctx) return;
      ctx.clearRect(0,0,overlay.width, overlay.height);
      // crosshair
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'rgba(255,255,255,0.9)';
      ctx.beginPath();
      ctx.moveTo(px-12, py);
      ctx.lineTo(px+12, py);
      ctx.moveTo(px, py-12);
      ctx.lineTo(px, py+12);
      ctx.stroke();
      // center circle
      ctx.fillStyle = 'rgba(0,0,0,0.4)';
      ctx.beginPath(); ctx.arc(px,py,6,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='rgba(255,255,255,0.6)'; ctx.lineWidth=1; ctx.beginPath(); ctx.arc(px,py,6,0,Math.PI*2); ctx.stroke();

      // show locked color border if locked
      if(lockedColor){
        ctx.fillStyle = lockedColor.hex;
        ctx.globalAlpha = 0.18;
        ctx.fillRect(8,8,120,36);
        ctx.globalAlpha = 1;
        ctx.strokeStyle = '#ffffff20'; ctx.strokeRect(8,8,120,36);
        ctx.font = '12px ui-monospace,monospace'; ctx.fillStyle='#fff'; ctx.fillText(lockedColor.hex + '  R:'+lockedColor.r+' G:'+lockedColor.g+' B:'+lockedColor.b, 14, 32);
      }
    }

    function updateColor(r,g,b){
      const hex = rgbToHex(r,g,b);
      swatch.style.background = hex;
      rgbVal.textContent = `R: ${r}   G: ${g}   B: ${b}`;
      hexVal.textContent = `HEX: ${hex}`;
      // store last seen if not locked
      if(!lockedColor){ lockedColor = null; }
      // store for copy buttons even if not locked
      lastSeen = { r,g,b,hex };
    }

    function rgbToHex(r,g,b){
      return '#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('').toUpperCase();
    }

    // copy helpers
    async function copyText(t){
      try{ await navigator.clipboard.writeText(t); alert('Copied: '+t); }catch(e){
        // fallback
        const ta = document.createElement('textarea'); ta.value = t; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); alert('Copied: '+t); }catch(e2){ alert('Copy failed: '+e2); } ta.remove(); }
    }

    // events
    let lastSeen = {r:0,g:0,b:0,hex:'#000000'};
    overlay.addEventListener('mousemove', (ev)=>{ mouseX = ev.clientX; mouseY = ev.clientY; });
    overlay.addEventListener('click', ()=>{
      if(!stream) return;
      if(lockedColor){ lockedColor = null; lockBtn.textContent = 'Lock'; sampling = true; setStatus('live sampling','var(--success)'); return; }
      // lock color from lastSeen
      lockedColor = { r: lastSeen.r, g: lastSeen.g, b: lastSeen.b, hex: lastSeen.hex };
      lockBtn.textContent = 'Unlock'; sampling = false; setStatus('color locked');
    });

    // UI buttons
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    sampleSize.addEventListener('input', ()=>{ sampleSizeLbl.textContent = sampleSize.value; });
    copyRgb.addEventListener('click', ()=>{ copyText(`rgb(${lastSeen.r}, ${lastSeen.g}, ${lastSeen.b})`); });
    copyHex.addEventListener('click', ()=>{ copyText(lastSeen.hex); });
    lockBtn.addEventListener('click', ()=>{
      if(!stream) return;
      if(lockedColor){ lockedColor = null; lockBtn.textContent = 'Lock'; sampling = true; setStatus('live sampling','var(--success)'); }
      else{ lockedColor = { r: lastSeen.r, g: lastSeen.g, b: lastSeen.b, hex: lastSeen.hex }; lockBtn.textContent = 'Unlock'; sampling = false; setStatus('color locked'); }
    });

    // stop camera when page hidden
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden) { /* optionally stopCamera(); */ } });

    // init: make overlay cover video area and listen for mouse on stage
    const stage = document.getElementById('stage');
    stage.addEventListener('mousemove', (e)=>{ mouseX = e.clientX; mouseY = e.clientY; });
    stage.addEventListener('click', ()=>{ /* delegated to overlay click */ });

    // If the user opens the file and wants to start automatically, uncomment below line
    // startCamera();
  </script>
</body>
</html>
